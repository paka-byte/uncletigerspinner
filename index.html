<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>FPL Tiger Lucky Draw </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f6d2b8;
      color: #000;
      text-align: center;
      padding: 20px;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    h1 { margin-bottom: 20px; font-size: 28px; }
    input, button {
      padding: 10px 15px;
      font-size: 1rem;
      margin: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #spinBtn, #addNameBtn {
      background: linear-gradient(135deg,#ff914d,#ffb84d);
      color: #fff;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: relative; z-index: 2;
    }
    #spinBtn:hover, #addNameBtn:hover { opacity: 0.9; }

    .container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      margin-top: 20px;
      z-index: 2;
    }
    .wheel-wrap {
      position: relative;
      width: 400px;
      height: 400px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      border-radius: 50%;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
      background: #fff;
    }
    .hide { display: none; }

    #logo img { width: 200px; cursor: pointer; position: relative; z-index: 2; }
    .spin { animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    /* ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ */
    #nameList {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      position: relative; z-index: 2;
    }
    .name-tag {
      background: #ffe5c2;
      border: 1px solid #ff914d;
      border-radius: 18px;
      padding: 6px 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .remove-btn {
      background: none;
      color: #c0392b;
      border: none;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s;
    }
    .remove-btn:hover { color: #e74c3c; }

    /* ‡πÄ‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏±‡πà‡∏ß‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏î) */
    .mini-tiger {
      position: fixed;
      width: 60px;
      border-radius: 50%;
      animation-name: spin;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
      opacity: 0.85;
      pointer-events: none;
      will-change: left, top;
      z-index: 1;
    }

    /* Popup */
    #winnerPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.25);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 10;
    }
    #winnerPopup.show { opacity: 1; pointer-events: auto; }
    .popup-card {
      background: #f6d2b8;
      border: 2px solid #000;
      border-radius: 20px;
      padding: 30px 40px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      transform: scale(0.85);
      animation: fadeIn 0.5s ease forwards;
    }
    .popup-card h2 { margin: 0 0 15px; font-size: 28px; }
    .popup-card p { font-size: 20px; margin: 0 0 20px; }
    .popup-card button {
      background: linear-gradient(135deg,#ff914d,#ffb84d);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.85); }
      to   { opacity: 1; transform: scale(1); }
    }

    /* Placeholder */
    .placeholder {
      background: #ffe5c2;
      border: 2px dashed #ff914d;
      padding: 16px 24px;
      border-radius: 16px;
      font-size: 18px;
      color: #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative; z-index: 2;
    }
    .placeholder img {
      width: 40px;
      height: 40px;
      animation: bounce 1.2s infinite;
    }
    @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }

    /* ‡πÅ‡∏ñ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏¢‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    .name-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    #nameInput {
      min-width: 220px;
    }
  </style>
</head>
<body>
  <h1>üéÅ Lucky Draw ‚Äî FPL Tiger</h1>

  <input type="file" id="fileInput" accept=".csv,.xlsx"><br>
  <input type="text" id="prizeInput" placeholder="‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?"><br>

  <div class="name-row">
    <input
      type="text"
      id="nameInput"
      placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏∏‡πâ‡∏ô"
      autocapitalize="words"
      autocomplete="off"
      spellcheck="false"
      enterkeyhint="done"
    >
    <button id="addNameBtn">‚ûï ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠</button>
  </div>

  <button id="spinBtn">üêØ ‡∏Å‡∏î‡πÄ‡∏™‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡πà‡∏ô!</button>

  <div class="container">
    <div class="wheel-wrap">
      <canvas id="wheelCanvas" width="400" height="400" class="hide"></canvas>
      <div id="placeholder" class="placeholder">
        <img src="images/logo.png" alt="Tiger Icon">
        <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡πà‡∏ô!</span>
      </div>
    </div>
    <div id="logo">
      <img src="images/logo.png" alt="FPL Tiger" id="tigerLogo">
    </div>

    <!-- ‡πÄ‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å 7 ‡∏ï‡∏±‡∏ß -->
    <img src="images/logo.png" class="mini-tiger" alt="">
    <img src="images/logo.png" class="mini-tiger" alt="">
    <img src="images/logo.png" class="mini-tiger" alt="">
    <img src="images/logo.png" class="mini-tiger" alt="">
    <img src="images/logo.png" class="mini-tiger" alt="">
    <img src="images/logo.png" class="mini-tiger" alt="">
    <img src="images/logo.png" class="mini-tiger" alt="">
  </div>

  <div id="nameList"></div>

  <!-- Popup -->
  <div id="winnerPopup">
    <div class="popup-card">
      <h2>üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! üéâ</h2>
      <p id="winnerText"></p>
      <button onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <audio id="spinSound" src="sounds/spin.mp3" preload="auto"></audio>
  <audio id="winSound"  src="sounds/win.mp3"  preload="auto"></audio>

<script>
let names = [];
let startAngle = 0;
let arc = 0;
let isSpinning = false;
let spinDuration = 8000; // 8 ‡∏ß‡∏¥
let startTime;

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const nameList = document.getElementById("nameList");
const placeholder = document.getElementById("placeholder");

// ================== ‡πÄ‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å: ‡∏™‡∏õ‡∏¥‡∏ô + ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡∏à‡∏≠ ==================
const tigers = Array.from(document.querySelectorAll(".mini-tiger"));

// ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å (4‚Äì10 ‡∏ß‡∏¥‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö)
tigers.forEach(tiger => {
  const speed = (Math.random() * 6 + 4).toFixed(1);
  tiger.style.animationDuration = `${speed}s`;
});

// ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ requestAnimationFrame (‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏¥‡∏® + ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏≠‡∏ö)
const BASE_SPEED_MIN = 40;
const BASE_SPEED_MAX = 100;

function rand(min, max){ return Math.random() * (max - min) + min; }

const tigerState = tigers.map(t => {
  const w = 60, h = 60;
  const x = rand(0, Math.max(0, window.innerWidth  - w));
  const y = rand(0, Math.max(0, window.innerHeight - h));
  const ang = rand(0, Math.PI * 2);
  const spd = rand(BASE_SPEED_MIN, BASE_SPEED_MAX);
  const vx = Math.cos(ang) * spd;
  const vy = Math.sin(ang) * spd;
  t.style.left = x + "px";
  t.style.top  = y + "px";
  return { el:t, x, y, vx, vy, w, h };
});

let lastTs = null;
function animateTigers(ts){
  if(lastTs === null) lastTs = ts;
  const dt = (ts - lastTs)/1000;
  lastTs = ts;

  const W = window.innerWidth, H = window.innerHeight;

  tigerState.forEach(s=>{
    s.x += s.vx * dt;
    s.y += s.vy * dt;

    if(s.x <= 0){ s.x = 0; s.vx = Math.abs(s.vx); }
    if(s.x >= W - s.w){ s.x = W - s.w; s.vx = -Math.abs(s.vx); }
    if(s.y <= 0){ s.y = 0; s.vy = Math.abs(s.vy); }
    if(s.y >= H - s.h){ s.y = H - s.h; s.vy = -Math.abs(s.vy); }

    s.el.style.left = s.x + "px";
    s.el.style.top  = s.y + "px";
  });

  requestAnimationFrame(animateTigers);
}
requestAnimationFrame(animateTigers);

window.addEventListener("resize", ()=>{
  const W = window.innerWidth, H = window.innerHeight;
  tigerState.forEach(s=>{
    s.x = Math.min(Math.max(0, s.x), Math.max(0, W - s.w));
    s.y = Math.min(Math.max(0, s.y), Math.max(0, H - s.h));
    s.el.style.left = s.x + "px";
    s.el.style.top  = s.y + "px";
  });
});

// ======================= Lucky Wheel =======================
function renderNameList(){
  nameList.innerHTML = "";
  names.forEach((n,i)=>{
    let tag = document.createElement("div");
    tag.className="name-tag";
    tag.innerHTML = `${n} <button class="remove-btn" data-index="${i}">‚úñ</button>`;
    nameList.appendChild(tag);
  });
  document.querySelectorAll(".remove-btn").forEach(btn=>{
    btn.addEventListener("click", e=>{
      let idx = e.target.getAttribute("data-index");
      names.splice(idx,1);
      arc = names.length>0 ? Math.PI*2/names.length : 0;
      drawRouletteWheel();
      renderNameList();
    });
  });
  if(names.length === 0){
    placeholder.style.display = "flex";
    canvas.classList.add("hide");
  } else {
    placeholder.style.display = "none";
    canvas.classList.remove("hide");
  }
}

function drawRouletteWheel() {
  let outsideRadius = 180;
  let textRadius = 140;
  let insideRadius = 50;

  ctx.clearRect(0,0,400,400);
  if(names.length === 0) return;

  ctx.strokeStyle = "black";
  ctx.lineWidth = 2;
  ctx.font = "16px Segoe UI";

  for(let i = 0; i < names.length; i++) {
    let angle = startAngle + i * arc;
    ctx.fillStyle = i % 2 === 0 ? "#ffcc80" : "#ffb74d";

    ctx.beginPath();
    ctx.arc(200, 200, outsideRadius, angle, angle + arc, false);
    ctx.arc(200, 200, insideRadius, angle + arc, angle, true);
    ctx.fill();
    ctx.stroke();

    ctx.save();
    ctx.fillStyle = "#000";
    ctx.translate(200 + Math.cos(angle + arc / 2) * textRadius,
                  200 + Math.sin(angle + arc / 2) * textRadius);
    ctx.rotate(angle + arc / 2);
    let text = names[i];
    ctx.fillText(text, -ctx.measureText(text).width/2, 0);
    ctx.restore();
  }

  // icon ‡πÄ‡∏™‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
  let img = new Image();
  img.src = "images/logo.png";
  img.onload = () => {
    ctx.save();
    ctx.beginPath();
    ctx.arc(200,200,insideRadius,0,Math.PI*2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(img,170,170,60,60);
    ctx.restore();
  };

  // marker ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.moveTo(190,20);
  ctx.lineTo(210,20);
  ctx.lineTo(200,40);
  ctx.closePath();
  ctx.fill();
}

function rotateWheel(timestamp) {
  if (!startTime) startTime = timestamp;
  let elapsed = timestamp - startTime;
  let progress = elapsed / spinDuration;
  let easeOut = Math.pow(1 - progress, 3);
  let spinAngleDelta = easeOut * 20;
  startAngle += (spinAngleDelta * Math.PI / 180);
  drawRouletteWheel();
  if(elapsed < spinDuration) requestAnimationFrame(rotateWheel);
  else stopRotateWheel();
}

function stopRotateWheel() {
  isSpinning = false;

  let degrees = startAngle * 180 / Math.PI + 90;
  let arcd = arc * 180 / Math.PI;
  let index = Math.floor((360 - degrees % 360) / arcd) % names.length;
  let winner = names[index];

  const spinS = document.getElementById("spinSound");
  const winS  = document.getElementById("winSound");
  try { spinS.pause(); } catch(e){}
  winS.currentTime = 0;
  winS.play().catch(()=>{});

  document.getElementById("tigerLogo").classList.remove("spin");

  let prize = document.getElementById("prizeInput").value || "‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©";
  document.getElementById("winnerText").innerHTML =
    `‡∏Ñ‡∏∏‡∏ì <b>${winner}</b> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• <b>${prize}</b> üèÜ`;
  document.getElementById("winnerPopup").classList.add("show");
}

function closePopup(){
  document.getElementById("winnerPopup").classList.remove("show");
}

// ---------- Mobile-friendly triggers ----------
// ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏∞
function unlockAudio(){
  const spinS = document.getElementById("spinSound");
  const winS  = document.getElementById("winSound");
  [spinS, winS].forEach(a=>{
    a.muted = true;
    a.play().then(()=>{ a.pause(); a.currentTime = 0; a.muted = false; }).catch(()=>{});
  });
  document.removeEventListener("touchstart", unlockAudio);
  document.removeEventListener("mousedown", unlockAudio);
}
document.addEventListener("touchstart", unlockAudio, { once:true });
document.addEventListener("mousedown", unlockAudio, { once:true });

// ‡∏¢‡∏π‡∏ó‡∏¥‡∏•‡∏¥‡∏ï‡∏µ‡πâ bindTap: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á click ‡πÅ‡∏•‡∏∞ touchend
function bindTap(el, handler){
  el.addEventListener("click", (e)=>{ e.preventDefault(); handler(); });
  el.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(); }, { passive:false });
}
bindTap(document.getElementById("spinBtn"), startSpin);
bindTap(document.getElementById("tigerLogo"), startSpin);

// ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Å‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
bindTap(document.getElementById("addNameBtn"), () => {
  addNameFromInput(document.getElementById("nameInput"));
});

function startSpin(){
  if(isSpinning || names.length === 0) {
    if(names.length === 0){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡πà‡∏ô‡∏ô‡∏∞!");
    }
    return;
  }
  isSpinning = true;
  startTime = null;

  const spinS = document.getElementById("spinSound");
  try {
    spinS.currentTime = 0;
    spinS.play().catch(()=>{});
  } catch(e){}

  document.getElementById("tigerLogo").classList.add("spin");
  requestAnimationFrame(rotateWheel);
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ Space/Enter (‡πÄ‡∏î‡∏¥‡∏°) + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á (‡πÉ‡∏´‡∏°‡πà)
document.getElementById("nameInput").addEventListener("keydown", function(e){
  if(e.code === "Space" || e.code === "Enter") {
    e.preventDefault();
    addNameFromInput(this);
  }
});

function addNameFromInput(inputEl){
  let val = inputEl.value.trim();
  if(val) {
    names.push(val);
    arc = Math.PI * 2 / names.length;
    drawRouletteWheel();
    renderNameList();
    inputEl.value = "";

    // ‡∏ü‡∏µ‡∏î‡πÅ‡∏ö‡πá‡∏Å‡∏™‡∏±‡πâ‡∏ô‡πÜ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    if (navigator.vibrate) navigator.vibrate(10);
  }
}

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
document.getElementById("fileInput").addEventListener("change", function(e){
  Papa.parse(e.target.files[0], {
    complete: function(results) {
      names = results.data.flat().map(n=>String(n).trim()).filter(n => n !== "");
      arc = names.length>0 ? Math.PI * 2 / names.length : 0;
      drawRouletteWheel();
      renderNameList();
    }
  });
});

drawRouletteWheel();
renderNameList();
</script>
</body>
</html>
